var a=new getApp,t=a.siteInfo.uniacid,e=wx.getStorageSync("kejia_farm_uid");Page({data:{seed:[],totalPrice:0,copyTotalPrice:0,couponCount:0,userCoupon:[],lid:"",farmSetData:[],order_id:0},onLoad:function(n){var o=n.lid;if(wx.getStorageSync("kejia_farm_buy_seed")){var i=this,c=wx.getStorageSync("kejia_farm_buy_seed"),d=n.total_price;this.setData({seed:c,totalPrice:d,copyTotalPrice:d,lid:o}),a.util.request({url:"entry/wxapp/coupon",data:{op:"getUseCouponCount",uniacid:t,type:5,totalprice:d,uid:e},success:function(a){console.log(a),i.setData({couponCount:a.data.couponCount})}})}this.setData({farmSetData:wx.getStorageSync("kejia_farm_setData")})},selectCoupon:function(a){var t=this.data.copyTotalPrice;wx.navigateTo({url:"../../coupon/useCoupon/index?type=5&totalPrice="+t})},onShow:function(){var a=this.data.copyTotalPrice;if(wx.getStorageSync("user_coupon")){var t=wx.getStorageSync("user_coupon");wx.removeStorageSync("user_coupon"),this.setData({userCoupon:t,totalPrice:parseFloat(a-t.coupon.coupon_price).toFixed(2)})}else this.setData({userCoupon:[],totalPrice:a})},surePay:function(e){for(var n=this,o=n.data.seed,i=new Array,c=new Array,d=n.data.totalPrice,u=n.data.lid,s=0;s<o.length;s++)i[s]=o[s].id,c[s]=o[s].num;var r=n.data.userCoupon,p=0,l=0;""!=r&&(console.log(r),p=r.coupon.id,l=r.coupon.coupon_price);var g=wx.getStorageSync("kejia_farm_uid");if(0!=g){var f=n.data.order_id;f?a.util.request({url:"entry/wxapp/land",data:{op:"addSendOrder",uniacid:t,uid:g,total_price:d,sid:i.join("_"),count:c.join("_"),coupon_id:p,coupon_price:l,lid:u,order_id:f},success:function(e){a.util.request({url:"entry/wxapp/sendPay",data:{orderid:f,uniacid:t},cachetime:"0",success:function(e){if(console.log(e),e.data&&e.data.data&&!e.data.errno){var n=e.data.data.package;wx.requestPayment({timeStamp:e.data.data.timeStamp,nonceStr:e.data.data.nonceStr,package:e.data.data.package,signType:"MD5",paySign:e.data.data.paySign,success:function(e){a.util.request({url:"entry/wxapp/land",data:{op:"notify_send",order_id:f,uniacid:t,prepay_id:n,lid:u},success:function(a){wx.showToast({title:"支付成功",success:function(a){wx.navigateTo({url:"../index/index?lid="+u})}})}})},fail:function(a){wx.showModal({title:"系统提示",content:"您取消了支付",showCancel:!1,success:function(a){}})}})}},fail:function(a){wx.showModal({title:"系统提示",content:a.data.message?a.data.message:"错误",showCancel:!1,success:function(a){}})}})}}):a.util.request({url:"entry/wxapp/land",data:{op:"addSendOrder",uniacid:t,uid:g,total_price:d,sid:i.join("_"),count:c.join("_"),coupon_id:p,coupon_price:l,lid:u},success:function(e){var o=e.data.order_id;n.setData({order_id:o}),a.util.request({url:"entry/wxapp/sendPay",data:{orderid:o,uniacid:t},cachetime:"0",success:function(e){if(console.log(e),e.data&&e.data.data&&!e.data.errno){var n=e.data.data.package;wx.requestPayment({timeStamp:e.data.data.timeStamp,nonceStr:e.data.data.nonceStr,package:e.data.data.package,signType:"MD5",paySign:e.data.data.paySign,success:function(e){a.util.request({url:"entry/wxapp/land",data:{op:"notify_send",order_id:o,uniacid:t,prepay_id:n,lid:u},success:function(a){wx.showToast({title:"支付成功",success:function(a){wx.navigateTo({url:"../index/index?lid="+u})}})}})},fail:function(a){wx.showModal({title:"系统提示",content:"您取消了支付",showCancel:!1,success:function(a){}})}})}},fail:function(a){wx.showModal({title:"系统提示",content:a.data.message?a.data.message:"错误",showCancel:!1,success:function(a){}})}})}})}else wx.navigateTo({url:"../../../login/index"})}}); 
